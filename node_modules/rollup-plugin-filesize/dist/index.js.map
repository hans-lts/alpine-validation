{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import { readFile as origReadFile } from \"fs\";\nimport { promisify } from \"util\";\nimport { dirname, resolve as pathResolve, join } from \"path\";\n\nimport fileSize from \"filesize\";\nimport gzip from \"gzip-size\";\nimport terser from \"terser\";\nimport brotli from \"brotli-size\";\nimport pacote from \"pacote\";\n\nconst readFile = promisify(origReadFile);\n\nconst isWindows = process.platform === \"win32\";\n\nfunction fixWindowsPath(path) {\n\treturn path.slice(\n\t\t// istanbul ignore next\n\t\tisWindows ? 1 : 0\n\t);\n}\n\n// Node should be ok with this, but transpiling\n//  to `require` doesn't work, so detect Windows\n//  to remove slash instead\n// \"file://\" +\nconst thisDirectory = fixWindowsPath(\n\tdirname(\n\t\tdecodeURI(\n\t\t\tnew URL(\n\t\t\t\t// `import.meta.url` is giving backslashes in Windows currently\n\t\t\t\t//  (at least in how it is compiled to CJS) which makes for an\n\t\t\t\t//  invalid URL\n\t\t\t\timport.meta.url.replace(/\\\\/g, \"/\")\n\t\t\t).pathname\n\t\t)\n\t)\n);\n\nexport default function filesize(options = {}, env) {\n\tlet {\n\t\trender,\n\t\tformat = {},\n\t\ttheme = \"dark\",\n\t\tshowBeforeSizes = \"none\",\n\t\tshowGzippedSize = true,\n\t\tshowBrotliSize = false,\n\t\tshowMinifiedSize = true,\n\t} = options;\n\n\tconst getLoggingData = async function (outputOptions, bundle) {\n\t\tconst { code, fileName } = bundle;\n\t\tconst info = {};\n\n\t\tlet codeBefore;\n\t\tif (showBeforeSizes !== \"none\") {\n\t\t\tlet file = outputOptions.file || outputOptions.dest;\n\t\t\tif (showBeforeSizes !== \"build\") {\n\t\t\t\tconst { name } = await import(join(process.cwd(), \"./package.json\"));\n\t\t\t\ttry {\n\t\t\t\t\tconst output = join(thisDirectory, \"../.cache\");\n\n\t\t\t\t\tconst { resolved } = await pacote.extract(`${name}@latest`, output);\n\t\t\t\t\tconst idx = resolved.lastIndexOf(name);\n\t\t\t\t\tconst lastVersion = resolved.slice(\n\t\t\t\t\t\tidx + name.length + 1,\n\t\t\t\t\t\t-\".tgz\".length\n\t\t\t\t\t);\n\t\t\t\t\tinfo.lastVersion = lastVersion;\n\n\t\t\t\t\tfile = pathResolve(output, file);\n\t\t\t\t} catch (err) {\n\t\t\t\t\t// Package might not exist\n\t\t\t\t\tconsole.log(`Package, \"${name}\", was not found.`);\n\t\t\t\t\tfile = null;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (file) {\n\t\t\t\ttry {\n\t\t\t\t\tcodeBefore = await readFile(file, \"utf8\");\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.log(`File, \"${file}\", was not found.`);\n\t\t\t\t\t// File might not exist\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tinfo.fileName = fileName;\n\n\t\tinfo.bundleSize = fileSize(Buffer.byteLength(code), format);\n\n\t\tinfo.brotliSize = showBrotliSize\n\t\t\t? fileSize(await brotli(code), format)\n\t\t\t: \"\";\n\n\t\tif (showMinifiedSize || showGzippedSize) {\n\t\t\tconst minifiedCode = (await terser.minify(code)).code;\n\t\t\tinfo.minSize = showMinifiedSize\n\t\t\t\t? fileSize(minifiedCode.length, format)\n\t\t\t\t: \"\";\n\t\t\tinfo.gzipSize = showGzippedSize\n\t\t\t\t? fileSize(gzip.sync(minifiedCode), format)\n\t\t\t\t: \"\";\n\t\t}\n\n\t\tif (codeBefore) {\n\t\t\tinfo.bundleSizeBefore = fileSize(Buffer.byteLength(codeBefore), format);\n\t\t\tinfo.brotliSizeBefore = showBrotliSize\n\t\t\t\t? fileSize(await brotli(codeBefore), format)\n\t\t\t\t: \"\";\n\t\t\tif (showMinifiedSize || showGzippedSize) {\n\t\t\t\tconst minifiedCode = (await terser.minify(codeBefore)).code;\n\t\t\t\tinfo.minSizeBefore = showMinifiedSize\n\t\t\t\t\t? fileSize(minifiedCode.length, format)\n\t\t\t\t\t: \"\";\n\t\t\t\tinfo.gzipSizeBefore = showGzippedSize\n\t\t\t\t\t? fileSize(gzip.sync(minifiedCode), format)\n\t\t\t\t\t: \"\";\n\t\t\t}\n\t\t}\n\n\t\tconst opts = {\n\t\t\tformat,\n\t\t\ttheme,\n\t\t\trender,\n\t\t\tshowBeforeSizes,\n\t\t\tshowGzippedSize,\n\t\t\tshowBrotliSize,\n\t\t\tshowMinifiedSize,\n\t\t};\n\n\t\tif (render) {\n\t\t\tconsole.warn(\n\t\t\t\t\"`render` is now deprecated. Please use `reporter` instead.\"\n\t\t\t);\n\t\t\treturn opts.render(opts, outputOptions, info);\n\t\t}\n\n\t\tconst reporters = options.reporter\n\t\t\t? Array.isArray(options.reporter)\n\t\t\t\t? options.reporter\n\t\t\t\t: [options.reporter]\n\t\t\t: [\"boxen\"];\n\n\t\treturn (\n\t\t\tawait Promise.all(\n\t\t\t\treporters.map(async (reporter) => {\n\t\t\t\t\tif (typeof reporter === \"string\") {\n\t\t\t\t\t\tlet p;\n\t\t\t\t\t\tif (reporter === \"boxen\") {\n\t\t\t\t\t\t\tp = import(join(thisDirectory, \"/reporters/boxen.js\"));\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tp = import(pathResolve(process.cwd(), reporter));\n\t\t\t\t\t\t}\n\t\t\t\t\t\treporter = (await p).default;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn reporter(opts, outputOptions, info);\n\t\t\t\t})\n\t\t\t)\n\t\t).join(\"\");\n\t};\n\n\tif (env === \"test\") {\n\t\treturn getLoggingData;\n\t}\n\n\treturn {\n\t\tname: \"filesize\",\n\t\tasync generateBundle(outputOptions, bundle /* , isWrite */) {\n\t\t\tconst dataStrs = await Promise.all(\n\t\t\t\tObject.keys(bundle)\n\t\t\t\t\t.map((fileName) => bundle[fileName])\n\t\t\t\t\t.filter((currentBundle) => {\n\t\t\t\t\t\tif ({}.hasOwnProperty.call(currentBundle, \"type\")) {\n\t\t\t\t\t\t\treturn currentBundle.type !== \"asset\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn !currentBundle.isAsset;\n\t\t\t\t\t})\n\t\t\t\t\t.map((currentBundle) => {\n\t\t\t\t\t\treturn getLoggingData(outputOptions, currentBundle);\n\t\t\t\t\t})\n\t\t\t);\n\t\t\tdataStrs.forEach((str) => {\n\t\t\t\tif (str) {\n\t\t\t\t\tconsole.log(str);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t};\n}\n"],"names":["readFile","promisify","origReadFile","isWindows","process","platform","fixWindowsPath","path","slice","thisDirectory","dirname","decodeURI","URL","import","replace","pathname","filesize","options","env","render","format","theme","showBeforeSizes","showGzippedSize","showBrotliSize","showMinifiedSize","getLoggingData","outputOptions","bundle","code","fileName","info","codeBefore","file","dest","name","join","cwd","output","resolved","pacote","extract","idx","lastIndexOf","lastVersion","length","pathResolve","err","console","log","bundleSize","fileSize","Buffer","byteLength","brotliSize","brotli","minifiedCode","terser","minify","minSize","gzipSize","gzip","sync","bundleSizeBefore","brotliSizeBefore","minSizeBefore","gzipSizeBefore","opts","warn","reporters","reporter","Array","isArray","Promise","all","map","p","default","generateBundle","dataStrs","Object","keys","filter","currentBundle","hasOwnProperty","call","type","isAsset","forEach","str"],"mappings":"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"}